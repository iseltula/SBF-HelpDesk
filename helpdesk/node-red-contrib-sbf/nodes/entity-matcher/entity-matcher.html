<script type="text/javascript">
  RED.nodes.registerType('entity-matcher', {
    category: 'SBF',
    color: '#dec074',
    icon: 'function.png',
    inputs: 1,
    outputs: 1,
    defaults: {
      botServer: {
        value: '',
        required: true,
        type: 'bot-server'
      },
      entities: {
        value: '',
        required: true
      }
    },
    label: function() {
      var lbl = this.entities && this.entities.length > 1 ? 'Entities: ' : 'Entity: '
      return this.entities ? lbl + this.entities : 'entity-matcher';
    },
    labelStyle: function() {
      return this.entities === '' ? 'node_label_italic' : '';
    },
    oneditprepare: function() {
      var that = this;
      var args = {
        url: RED.settings.httpNodeRoot + '/' + this.botServer + '/entities'
      };
      $.ajax(args)
        .done(function(data) {
          var obj, selected;
          var existingvalue = that.entities;
          data = JSON.parse(data);
          for (var i = 0; i < data.length; i++) {
            obj = data[i];
            selected = '';
            if (existingvalue.indexOf(obj.name) > -1) {
              selected = ' selected';
            }
            $('#node-input-entities').append('<option value="' + obj.name + '"' + selected + '>' + obj.name + '</option>');
          }
        })
        .fail(function(err) {
          $('#node-input-entities').append('<option>' + err.message || err + '</option>');
        });
    }
  });
</script>
<script type="text/x-red" data-template-name="entity-matcher">
  <div class="form-row">
    <label for="node-input-botServer">Bot Server</label>
    <select id="node-input-botServer"></select>
  </div>
  <div class="form-row">
    <label for="node-input-entities">Entities</label>
    <select id="node-input-entities" multiple></select>
  </div>
</script>
<script type="text/x-red" data-help-name="entity-matcher">
  <p><strong>Purpose: </strong>allows selection of LUIS entities from the matched intents</p>
  <p>
    <strong>How to use:</strong>
    <p>It is assumed that in the LUIS App to which the current bot-server is connected has entities.</p>
    <p>When this node is dropped on the Editor, its editor will pull the existing entities from the current LUIS account</p>
  </p>
  <p>
    <strong>Inputs: 1</strong>
    <p><pre><code>
  msg.sbf.luisArgs
  </code></pre></p>
  </p>
  <p>
    <strong>Outputs: 1</strong>
    <p><pre><code>
    msg.payload = {
      entityKey: entityValue
    }
    // entityKey = name of the entity
    // entityValue = values populated by LUIS
  </code></pre>
    </p>
  </p>
  <p><strong>Quick Tips: </strong></p>
</script>
