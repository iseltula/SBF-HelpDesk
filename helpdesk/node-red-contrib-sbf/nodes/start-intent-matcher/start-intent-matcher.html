<script type="text/javascript">
  RED.nodes.registerType('start-intent-matcher', {
    category: 'SBF',
    color: '#9aafb3',
    icon: 'inject.png',
    outputs: 1,
    defaults: {
      botServer: {
        value: '',
        type: 'bot-server',
        required: true
      },
      intentPattern: {
        value: '',
        required: true
      }
    },
    label: function() {
      return this.intentPattern ? 'Intent: ' + this.intentPattern : 'start-intent-matcher';
    },
    labelStyle: function() {
      return this.intentPattern === '' ? 'node_label_italic' : '';
    },
    oneditprepare: function() {
        var that = this;
        $('#node-input-botServer').change(function () {
            var args = {
                url: RED.settings.httpNodeRoot + '/' + $('#node-input-botServer').val() + '/intents'
            };
            $.ajax(args)
                .done(function (data) {
                    $('#node-input-intentPattern').html('');
                    var obj, selected;
                    var existingvalue = that.intentPattern;
                    data = JSON.parse(data);
                    for (var i = 0; i < data.length; i++) {
                        obj = data[i];
                        selected = '';
                        if (obj.name === existingvalue) {
                            selected = ' selected';
                        }
                        $('#node-input-intentPattern').append('<option value="' + obj.name + '"' + selected + '>' + obj.name + '</option>');
                    }
                })
                .fail(function (err) {
                    $('#node-input-intentPattern').append('<option>' + err.message || err + '</option>');
                });
        });
    }
  });
</script>
<script type="text/x-red" data-template-name="start-intent-matcher">
  <div class="form-row">
    <label for="node-input-botServer">Bot Server</label>
    <input type="text" id="node-input-botServer" placeholder="Bot Server" />
  </div>
  <div class="form-row">
    <label for="node-input-intentPattern">Intent Pattern</label>
    <select id="node-input-intentPattern"></select>
  </div>
</script>
<script type="text/x-red" data-help-name="start-intent-matcher">
  <p><strong>Purpose: </strong> to match the LUIS intents to begin a chat bot dialog</p>
  <p>This is usually the 1st step in creating a chat bot dialog</p>
  <p><strong>How to use: </strong></p>
  <ul>
    <li>Set the "Bot Server" setting either by adding a new bot server configuration or using a previously defined bot server from the dropdown.</li>
    <li>Select the intent which needs to be matched. NOTE: the "Intent Pattern" dropdown will not be filled till the BotServer is set correctly as this dropdown will pull all intents created in LUIS based off the BotServer settings</li>
  </ul>
  <p><strong>Inputs: </strong> none</p>
  <p><strong>Outputs: </strong> sets a new property to the message object</p>
  <p><pre><code>node.send({
      sbf: {
        session: Object, // object of the Bot Framework session
        botServer: {
          bot: Object, // object of the Bot Framework Universal Bot
          intent: Object, // object of the builder.IntentDialog for LUIS
          connector: Object, // object of the builder.ChatConnector for listening to a URL
        },
        luisArgs: Object // object of the LUIS intent matching object
      }
    });</code></pre></p>
  <p><strong>Quick Tips: </strong></p>
  <ul>
    <li>It is recommended to match intents in the flow & wire to specific flows via a sub-flow mechanism</li>
    <li>
      It is recommended to have the following intent matchers at a minimum:
      <ul>
        <li>An "introduction" matcher - to match start of the dialog conversations.</li>
        <li>An "exit" matcher - to match end of the conversations</li>
        <li>An "error/none" matcher - to handle cases where the user intent did not match any of the pre-defined intents</li>
      </ul>
    </li>
  </ul>
</script>
